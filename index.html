<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="yidier's blog" />










<meta name="description" content="a web developer">
<meta property="og:type" content="website">
<meta property="og:title" content="yidier&#39;s blogs">
<meta property="og:url" content="https://yidierh.github.io/index.html">
<meta property="og:site_name" content="yidier&#39;s blogs">
<meta property="og:description" content="a web developer">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yidier">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yidierh.github.io/"/>





  <title>yidier's blogs</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  

  <div class="container  
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">yidier's blogs</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yidierh.github.io/2020/05/21/20200521/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yidier">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yidier's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/21/20200521/" itemprop="url">一亿生日</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-21T17:21:00+08:00">
                2020-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2020/05/21/20200521/1.jpg" alt></p>
<p><img src="/2020/05/21/20200521/2.jpg" alt></p>
<p><img src="/2020/05/21/20200521/3.jpg" alt></p>
<blockquote>
<p>Happay birthday to 一亿.</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yidierh.github.io/2020/05/13/2020-5-13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yidier">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yidier's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/13/2020-5-13/" itemprop="url">WEB应用生命周期</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-13T23:04:44+08:00">
                2020-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">前端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2020/05/13/2020-5-13/1.jpg" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yidierh.github.io/2020/05/02/ES6%EF%BC%88Generator%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yidier">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yidier's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/02/ES6%EF%BC%88Generator%EF%BC%89/" itemprop="url">ES6（Generator）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-02T01:07:35+08:00">
                2020-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">前端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="生成器的类型判断"><a href="#生成器的类型判断" class="headerlink" title="生成器的类型判断"></a>生成器的类型判断</h2><h3 id="如何判断生成器对象"><a href="#如何判断生成器对象" class="headerlink" title="如何判断生成器对象"></a>如何判断生成器对象</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isGenerator</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> obj &amp;&amp; <span class="keyword">typeof</span> obj.next === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> obj.throw === <span class="string">'function'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与 promise 对象类似，这里运用鸭子模型进行判断，如果对象中有 next 与 throw 两个方法，那么就认为这个对象是一个生成器对象。</p>
<h3 id="如何判断生成器函数"><a href="#如何判断生成器函数" class="headerlink" title="如何判断生成器函数"></a>如何判断生成器函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isGeneratorFunction</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">constructor</span> = obj.<span class="keyword">constructor</span>;</span><br><span class="line">    if(!<span class="keyword">constructor</span>) return false;</span><br><span class="line">    if('GeneratorFunction' === <span class="keyword">constructor</span>.name || 'GeneratorFunction' === <span class="keyword">constructor</span>.displayName) return true;</span><br><span class="line">    return isGenerator(<span class="keyword">constructor</span>.prototype);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用函数的 constructor 构造器的名字来判断，为了兼容性使用 name 与 displayName 两个属性来进行判断. 这里递归调用 isGenerator 判断 constructor 的原型是因为有<br>自定义迭代器的存在.</p>
<h2 id="yield-与-next-传值问题"><a href="#yield-与-next-传值问题" class="headerlink" title="yield 与 next 传值问题"></a>yield 与 next 传值问题</h2><p>这个问题的答案需要清楚， 因为单独的 generator 是没有办法做异步任务流程化的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function *gen() &#123;</span><br><span class="line">    var re &#x3D; yield 1;</span><br><span class="line">    return re + 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gen &#x3D; gen();</span><br><span class="line">var g &#x3D; gen.next();</span><br><span class="line">console.log(&#39;1: &#39;, g.value);</span><br><span class="line">g &#x3D; gen.next();</span><br><span class="line">console.log(&#39;2: &#39;, g.value);</span><br><span class="line">g &#x3D; gen.next();</span><br><span class="line">console.log(&#39;3: &#39;, g.value);</span><br></pre></td></tr></table></figure>

<p>猜一下以上代码的 value 值分别为多少? 答案是 1, NaN, undefined. 为什么会出现这样的结果呢? gen 生成器函数本意是想做一个 1 + 2 简单的加法运算, 但是最后得到的结果是 NaN. 其实 generator 函数内部的 yield 是需要我们一个一个<br>使用 next 函数去调用一步一步得到的. 而 next 函数调用之后, 返回一个对象, 对象中有两个属性值:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    value: val,  <span class="comment">// 任意值</span></span><br><span class="line">    done: <span class="literal">true</span> <span class="comment">// 或者 false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而其中的 value 的值就是 yield 语句后面的 “值”, 注意这里的值不一定是 javascript 中的基本数据类型，yield 后面可以是函数，表达式(运算结果)，对象等等的值。可以查看下面的例子:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">gen</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">yield</span> &#123; <span class="attr">who</span>: <span class="string">'me'</span> &#125;;</span><br><span class="line">    <span class="keyword">yield</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'hello'</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span> + <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gen = gen();</span><br><span class="line"><span class="keyword">var</span> g1 = gen.next();</span><br><span class="line"><span class="built_in">console</span>.log(g1.value);  <span class="comment">// 1</span></span><br><span class="line"><span class="keyword">var</span> g2 = gen.next();</span><br><span class="line"><span class="built_in">console</span>.log(g2.value);  <span class="comment">// &#123; who: 'me' &#125;</span></span><br><span class="line"><span class="keyword">var</span> g3 = gen.next();</span><br><span class="line"><span class="built_in">console</span>.log(g3.value);  <span class="comment">// function()&#123; console.log('hello'); &#125;</span></span><br><span class="line"><span class="keyword">var</span> g4 = gen.next();</span><br><span class="line"><span class="built_in">console</span>.log(g4.value); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<p>那么问题出现了，既然 yield 后面的值可以通过 next 方法得到，那 yield 语句本身有没有返回值或者 yield 语句返回值如何得到呢？这个问题是 generator 异步流程控制的第一个问题， 上面说到 yield 后面是可以接函数或者表达式或基本值等等，但是<br>如果像 var tmp = yield 1; 这样的语句， tmp 变量并没有取到 1 的话，流程控制就无从谈起，甚至 yield 与生成器函数本身的作用也不太大， 所以这里就需要一个消息数据双向通道。<br>所谓消息双向通道就是我们可以从 next 函数中拿到 yield 语句后面的值，然后可以通过 next 函数传值把传进去的值变为 yield 语句的返回值。所以这也就解释了第一段代码为什么得到值是 NaN 了， 因为在处理的时候，我们没有给 next 函数传值，导致<br>yield 语句返回值为 undefined， undefined + 2 得到的当然就是 NaN.<br>这里还要解释一下第一段函数最后没有 yield 语句，但是 value 还有有值， 而且得到最后的结果 NaN，因为 value 的值是如果存在 yield 那么, 它的值就是 yield 后面接着的值, 如果没有 yield 那么就取 return 后面的值, 若都没有则返回 undefined(其实是相当于有个默认的 return undefined).<br>所以为了实现第一段代码的功能，我们需要：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">gen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> re = <span class="keyword">yield</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> re + <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gen = gen();</span><br><span class="line"><span class="keyword">var</span> g = gen.next();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'1: '</span>, g.value);  <span class="comment">// 1</span></span><br><span class="line">g = gen.next(g.value);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'2: '</span>, g.value);  <span class="comment">// 3</span></span><br><span class="line">g = gen.next();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'3: '</span>, g.value);  <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>

<p>最后一个是 undefined 是因为 yield 语句数量只有一个，在调用两个 next 函数之后已经结束( done === true )了， 所以 value 为 undefined.</p>
<h2 id="next-函数与-yield-个数不对等"><a href="#next-函数与-yield-个数不对等" class="headerlink" title="next 函数与 yield 个数不对等?"></a>next 函数与 yield 个数不对等?</h2><p>先看一个例子:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">gen</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="keyword">yield</span> <span class="number">1</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> num = <span class="keyword">yield</span> <span class="number">43</span>;</span><br><span class="line">    ret = <span class="keyword">yield</span> ret + num;</span><br><span class="line">    <span class="built_in">console</span>.log(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们怎么实现 1 + 2 + 4 这个功能呢？来看以下代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gen = gen(); <span class="comment">// 转换为 generator 对象</span></span><br><span class="line"><span class="keyword">var</span> g = gen.next(); <span class="comment">// 第一步启动</span></span><br><span class="line"><span class="keyword">var</span> firstStep = g.value; <span class="comment">// 取得第一个 yield 后面的表达式，即 1 + 2 为 3 </span></span><br><span class="line">g = gen.next(firstStep); <span class="comment">// 从 next 函数传入第一步的值，则 ret 值为 3</span></span><br><span class="line"><span class="keyword">var</span> secondStep = g.value; <span class="comment">// 取得第二步 yield 的值，即 4</span></span><br><span class="line">g = gen.next(secondStep); <span class="comment">// 从 next 函数传入第二步的值， 即 num 为 4</span></span><br><span class="line"><span class="comment">// 由于下面没有了 yield 语句，所以直接执行完函数，ret 为 &#123; value: 7, done: false &#125;</span></span><br><span class="line">g = gen.next(g.value);</span><br><span class="line"><span class="built_in">console</span>.log(g.done); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>可以看到， 其实第一个 next 函数是为了启动 generator，因为在还没有启动的时候，前面还没有 yield 语句，<br>所以即使你往第一个 next 函数中传值也没有用，它不会替代任何一个 yield 语句的值，所以我们会倾向于不向<br>第一个 next 函数中传值(undefined)。<br>然后接下来你可以看到，第一个 next 函数之后每个 next 函数对应着一个 yield 语句, 其实 next 函数通俗来讲就是<br>运行上一个 yield 语句与当前 yield 语句之间的代码, 而 next 函数传进去的值会变成上一个 yield 语句的返回值.<br>由此可知, next 函数调用次数与 yield 语句个数总是不对等, next 函数调用次数总是比 yield 语句多 1, 因为需要<br>第一个进行启动.</p>
<h2 id="异步流程控制"><a href="#异步流程控制" class="headerlink" title="异步流程控制"></a>异步流程控制</h2><p>单独的生成器作用并不大, 特别是在异步流程控制中, 即使 yield 后面可以添加异步任务, 但是我们仍然需要一个一个<br>地调用 next 函数, 如果需要流程化控制, 就需要自动执行 next 函数.而对于 yield + promise 结合的异步流程控制,<br>核心思想就是通过 next 函数取得 yield 后面的值, 然后将这个值转化为 Promise, 通过 Promise 来控制异步任务,<br>异步任务完成后递归重新调用 next 函数重复上面的操作.这里我推荐阅读 co 类库的源码, 它的思想与上面一致, 是<br>yield + promise 的精妙实现.具体可以查看我的另一篇博文– <a href="http://zhangxiang958.github.io/2018/02/25/co%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" target="_blank" rel="noopener">co 源码剖析</a>.<br>这里我们试试写一个简单的 promise + yield 控制器来理解一下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">gen</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = [].slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> gen === <span class="string">'function'</span>) gen = gen.apply(<span class="keyword">this</span>, args);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        onFulfilled();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">onFulfilled</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> it = gen.next(res);</span><br><span class="line">            next(it);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(res.done) <span class="keyword">return</span> resolve(res.value);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(res.value)</span><br><span class="line">                    .then(onFulfilled);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意此时 yield 后面的东西需要是一个 Promise 对象.</p>
<h2 id="yield-与-yield-的区别"><a href="#yield-与-yield-的区别" class="headerlink" title="yield 与 yield * 的区别"></a>yield 与 yield * 的区别</h2><p>在实际场景中, 异步任务可能并没有像 demo 中那么简单的关系, 可能会有 A-B-C 的异步任务, 而 B 中又包含 B-1,<br>B-2, B-3 这样的异步任务, 按照逻辑是需要完成 A 后再逐个完成 B-i 再执行 C.<br>问题在于不可能在一个函数内完成全部逻辑, 我们会需要在多个函数中编写逻辑, 这个时候 yield 后面可能需要加上<br>一个包裹型的函数:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">doTask</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="keyword">yield</span> A();</span><br><span class="line">    <span class="keyword">var</span> b = <span class="keyword">yield</span> run(B);</span><br><span class="line">    <span class="keyword">var</span> c = yeld C();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">B</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> b1 = <span class="keyword">yield</span> B1();</span><br><span class="line">    <span class="keyword">var</span> b2 = <span class="keyword">yield</span> B2();</span><br><span class="line">    <span class="keyword">var</span> b3 = <span class="keyword">yield</span> B3();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run(doTask);</span><br></pre></td></tr></table></figure>

<p>我们可以使用上面编写的 run 函数来做管理, 但是存在更好的方式就是使用 yield *, 注意这里和常规的 yield 多了<br>一个 * 符号.其实 yield * 的”学名”叫做 yield 委托, 看下面的例子:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'start *foo'</span>);</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'end *foo'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">bar</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">yield</span> *foo();</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> g = bar();</span><br><span class="line"> <span class="built_in">console</span>.log(g.next().value); <span class="comment">// 1</span></span><br><span class="line"> <span class="built_in">console</span>.log(g.next().value); <span class="comment">// 2</span></span><br><span class="line"> <span class="comment">// start *foo</span></span><br><span class="line"> <span class="built_in">console</span>.log(g.next().value); <span class="comment">// 3</span></span><br><span class="line"> <span class="built_in">console</span>.log(g.next().value); <span class="comment">// 4</span></span><br><span class="line"> <span class="comment">// end *foo</span></span><br><span class="line"> <span class="built_in">console</span>.log(g.next().value); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到, 使用 yield * 可以让函数先进入另外一个生成器函数内部执行完内部的步骤之后, 再返回上一层继续<br>执行上一层剩下的步骤.<br>简单地来说, yield * 提供了调用生成器函数的方法, 由于生成器方法的特殊, 所以 generator 提供了一个特殊的方式<br>调用生成器函数.好处在于你可以简单地执行嵌套的 yield, 而无需自己编写像 run 函数这样的工具.<br>yield * 除了后面加我们自己编写的生成器函数, 还可以加非一般的生成器函数, 比如数组的迭代器:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">yield</span> *[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">it.next().value; <span class="comment">// 1</span></span><br><span class="line">it.next().value; <span class="comment">// 2</span></span><br><span class="line">it.next().value; <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<p>但是注意这里这样的 yield * 语句是始终没有返回值的, 或者说是 undefined.</p>
<h2 id="ES5-中的生成器"><a href="#ES5-中的生成器" class="headerlink" title="ES5 中的生成器"></a>ES5 中的生成器</h2><p>生成器是 ES6 中的语法, 但是 ES6 的语法都是可以通过工具来转化为 ES5 的语法的, 为了更全面地认识生成器, 我们<br>来自己转化一下, 先假定有一个生成器函数:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">        request(<span class="string">'www.test.com/api'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">            resolve(res);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'start yield'</span>);</span><br><span class="line">        <span class="keyword">var</span> tmp = <span class="keyword">yield</span> bar();</span><br><span class="line">        <span class="built_in">console</span>.log(tmp);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> it = foo();</span><br></pre></td></tr></table></figure>

<p>既然是转化为 ES5 的语法, 那么变量 it, 也就是 foo 函数的返回值就应该是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function foo() &#123;</span><br><span class="line">    ....</span><br><span class="line">    return &#123;</span><br><span class="line">        next: function()&#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;,</span><br><span class="line">        throw: function()&#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道 yield 可以”暂停”函数运行, 那么换言之, 在内部就应该有一个对应的状态变量来标记函数运行到哪一步, 而<br>对于控制来说, switch 语句很合适, 根据变量采取对应的操作: 看一下完整代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> state;  <span class="comment">// 全局状态, 一开始值并不是 1, 因为需要一个 next 函数来启动</span></span><br><span class="line">    <span class="keyword">var</span> val; <span class="comment">// val 代表的是 yield 语句的返回值</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">progress</span>(<span class="params">v</span>) </span>&#123;</span><br><span class="line">        swtich(state)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'start yield'</span>);</span><br><span class="line">                <span class="keyword">return</span> bar();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                val = v;</span><br><span class="line">                <span class="built_in">console</span>.log(v);</span><br><span class="line">                <span class="comment">// yield 之后没有 return, 默认提供一个 return;</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="comment">// catch 中的逻辑</span></span><br><span class="line">                <span class="keyword">var</span> err = v;</span><br><span class="line">                <span class="built_in">console</span>.log(err);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生成器返回值</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        next: <span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(!state) &#123;</span><br><span class="line">                state = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    done: <span class="literal">false</span>,</span><br><span class="line">                    value: progress()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(state == <span class="number">1</span>)&#123;</span><br><span class="line">                state = <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    done: <span class="literal">true</span>,</span><br><span class="line">                    value: progress(v)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    done: <span class="literal">true</span>,</span><br><span class="line">                    value: <span class="literal">undefined</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">throw</span>: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(state == <span class="number">1</span>) &#123;</span><br><span class="line">                state = <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    done: <span class="literal">true</span>,</span><br><span class="line">                    value: progress(e)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说在转化为 ES5 的语法的时候, 生成器函数中的代码逻辑被分段, 上一个 yield 与下一个 yield 之间的代码被放到 switch 语句的中一个 case 中去, 然后根据一个闭包中的状态变量 state 执行一个个 case.然后 switch 包含在一个类似 progress 可供重复执行的函数中. progress 可以传入值, 值记录在一个闭包变量 val 中, 会使用在需要 yield 语句返回值的地方( var v = yield fn(), v 的值就是闭包变量 val 的值), progress 函数是一个私有方法.然后原生成器函数变为一个函数, 包含以上的逻辑, 返回值是一个对象, 其中包含 next 函数与 throw 函数的实现.<br>next 函数通过判断 state 的值, 不断将 state 值改变, 比如当 state 为 1 时, 执行 progress case 为 1 的逻辑,<br>然后修改 state 为 2(下一个状态), 当然 next 函数也可以直接传值, 传入值直接传到 progress 中, 然后执行刚说的 val 的逻辑.<br>throw 函数就是传入一个错误, 将初始状态(1)转为错误状态, 执行错误时的逻辑( progress ), 其他的状态直接抛出错误 throw.</p>
<ul>
<li><p>yield 总是先返回，再暂停。</p>
</li>
<li><p>next（n）与 yield (n + 1) 的关系。</p>
</li>
</ul>
<p>参考：</p>
<p><a href="https://github.com/zhangxiang958/zhangxiang958.github.io/issues/32" target="_blank" rel="noopener">理解 ES6 generator · Issue #32 · zhangxiang958/zhangxiang958.github.io · GitHub</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yidierh.github.io/2020/04/08/2020-04-08/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yidier">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yidier's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/08/2020-04-08/" itemprop="url">Vue 图片压缩并上传至服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-08T19:49:33+08:00">
                2020-04-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">前端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、工具类封装"><a href="#一、工具类封装" class="headerlink" title="一、工具类封装"></a>一、工具类封装</h2><p>本文主要讲解基于 Vue + Vant ，实现移动端图片选择，并用 Canvas 压缩图片，最后上传至服务器。还会封装一个工具类，方便直接调用。</p>
<p>废话不多说先上代码，封装一个 <code>CompressImageUtils</code> 工具类：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 图片压缩工具类</span></span><br><span class="line"><span class="comment"> * 最大高度和最大宽度都为 500，如果超出大小将等比例缩放。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意可能出现压缩后比原图更大的情况，在调用的地方自己判断大小并决定上传压缩前或压缩后的图到服务器。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将base64转换为blob</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">convertBase64UrlToBlob</span>(<span class="params">urlData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> arr = urlData.split(<span class="string">','</span>)</span><br><span class="line">  <span class="keyword">let</span> mime = arr[<span class="number">0</span>].match(<span class="regexp">/:(.*?);/</span>)[<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">let</span> bstr = atob(arr[<span class="number">1</span>])</span><br><span class="line">  <span class="keyword">let</span> n = bstr.length</span><br><span class="line">  <span class="keyword">let</span> u8arr = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(n)</span><br><span class="line">  <span class="keyword">while</span> (n--) &#123;</span><br><span class="line">    u8arr[n] = bstr.charCodeAt(n)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Blob([u8arr], &#123;<span class="attr">type</span>: mime&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩图片</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compressImage</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//最大高度</span></span><br><span class="line">  <span class="keyword">const</span> maxHeight = <span class="number">500</span>;</span><br><span class="line">  <span class="comment">//最大宽度</span></span><br><span class="line">  <span class="keyword">const</span> maxWidth = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> img = <span class="keyword">new</span> Image();</span><br><span class="line">    img.src = path;</span><br><span class="line">    img.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> originHeight = img.height;</span><br><span class="line">      <span class="keyword">const</span> originWidth = img.width;</span><br><span class="line">      <span class="keyword">let</span> compressedWidth = img.height;</span><br><span class="line">      <span class="keyword">let</span> compressedHeight = img.width;</span><br><span class="line">      <span class="keyword">if</span> ((originWidth &gt; maxWidth) &amp;&amp; (originHeight &gt; maxHeight)) &#123;</span><br><span class="line">        <span class="comment">// 更宽更高，</span></span><br><span class="line">        <span class="keyword">if</span> ((originHeight / originWidth) &gt; (maxHeight / maxWidth)) &#123;</span><br><span class="line">          <span class="comment">// 更加严重的高窄型，确定最大高，压缩宽度</span></span><br><span class="line">          compressedHeight = maxHeight</span><br><span class="line">          compressedWidth = maxHeight * (originWidth / originHeight)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//更加严重的矮宽型, 确定最大宽，压缩高度</span></span><br><span class="line">          compressedWidth = maxWidth</span><br><span class="line">          compressedHeight = maxWidth * (originHeight / originWidth)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (originWidth &gt; maxWidth &amp;&amp; originHeight &lt;= maxHeight) &#123;</span><br><span class="line">        <span class="comment">// 更宽，但比较矮，以maxWidth作为基准</span></span><br><span class="line">        compressedWidth = maxWidth</span><br><span class="line">        compressedHeight = maxWidth * (originHeight / originWidth)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (originWidth &lt;= maxWidth &amp;&amp; originHeight &gt; maxHeight) &#123;</span><br><span class="line">        <span class="comment">// 比较窄，但很高，取maxHight为基准</span></span><br><span class="line">        compressedHeight = maxHeight</span><br><span class="line">        compressedWidth = maxHeight * (originWidth / originHeight)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 符合宽高限制，不做压缩</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 生成canvas</span></span><br><span class="line">      <span class="keyword">let</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</span><br><span class="line">      <span class="keyword">let</span> context = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">      canvas.height = compressedHeight;</span><br><span class="line">      canvas.width = compressedWidth;</span><br><span class="line">      context.clearRect(<span class="number">0</span>, <span class="number">0</span>, compressedWidth, compressedHeight);</span><br><span class="line">      context.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, compressedWidth, compressedHeight);</span><br><span class="line">      <span class="keyword">let</span> base64 = canvas.toDataURL(<span class="string">'image/*'</span>, <span class="number">0.8</span>);</span><br><span class="line">      <span class="keyword">let</span> blob = convertBase64UrlToBlob(base64);</span><br><span class="line">      <span class="comment">// 回调函数返回blob的值。也可根据自己的需求返回base64的值</span></span><br><span class="line">      resolve(blob)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义的最大宽度和最大高度均为 500，如果图片的宽高至少有一个超出了 500，都会被 <strong>等比例压缩</strong>，不用担心变形。可以根据自己项目需要改变<code>maxWidth</code> 和 <code>maxHeight</code> 。</p>
<p>这里直接把压缩的最大高度和最大宽度写死为 500 了，没有在调用时传。因为一个项目压缩的逻辑和大小一般都一致的，没必要在每次调用的时候传。当然如果想写的灵活一点，可以在 <code>compressImage</code> 方法里再把 <code>maxWidth</code> 、 <code>maxHeight</code> 和压缩质量传上。</p>
<p><code>compressImage</code> 方法返回的是 blob 值，根据服务端接口需要可以改为返回 base64，只需将 <code>resolve(blob)</code> 改为 <code>resolve(base64)</code> 即可。</p>
<p>注意一点，对于有些宽高没到 500，且分辨率很小的图片，压缩之后可能比之前还大。猜测可能是 canvas 生成的图片分辨率要比原来高一些，所以最终的图片比压缩前更大。可以在调用的地方加个判断，如果压缩完的大小比原图小，就上传压缩后的图片；如果如果压缩完的大小比原图大，就上传原图。</p>
<h2 id="二、如何使用"><a href="#二、如何使用" class="headerlink" title="二、如何使用"></a>二、如何使用</h2><p>将 <code>CompressImageUtils</code> 引入到目标文件，然后调用 <code>compressImage</code> 方法，即可在回调里获得压缩后的结果。注意 <code>compressImage</code> 方法返回的是 Promise。<br>省略其他无关代码，只保留跟压缩图片和上传相关的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;van-uploader v-model=<span class="string">"fileList"</span> :after-read=<span class="string">"afterRead"</span> /&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">import</span> &#123;compressImage&#125; <span class="keyword">from</span> <span class="string">'../../utils/CompressImageUtils'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    components: &#123;&#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">//读取完图片后</span></span><br><span class="line">      afterRead(file) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'afterRead------'</span>, file);</span><br><span class="line">        <span class="keyword">this</span>._compressAndUploadFile(file);</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">//压缩图片上传</span></span><br><span class="line">      _compressAndUploadFile(file) &#123;</span><br><span class="line">        compressImage(file.content).then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'压缩后的结果'</span>, result); <span class="comment">// result即为压缩后的结果</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'压缩前大小'</span>, file.file.size);</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'压缩后大小'</span>, result.size);</span><br><span class="line">          <span class="keyword">if</span> (result.size &gt; file.file.size)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'上传原图'</span>);</span><br><span class="line">            <span class="comment">//压缩后比原来更大，则将原图上传</span></span><br><span class="line">            <span class="keyword">this</span>._uploadFile(file.file, file.file.name);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//压缩后比原来小，上传压缩后的</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'上传压缩图'</span>);</span><br><span class="line">            <span class="keyword">this</span>._uploadFile(result, file.file.name)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">//上传图片</span></span><br><span class="line">      _uploadFile(file, filename) &#123;</span><br><span class="line">        <span class="keyword">let</span> params = <span class="keyword">new</span> FormData();</span><br><span class="line">        params.append(<span class="string">"file"</span>, file, filename);</span><br><span class="line">        <span class="keyword">this</span>.$api.uploadImage(params).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'uploadImage'</span>, res);</span><br><span class="line">                    <span class="comment">//上传成功，写自己的逻辑</span></span><br><span class="line">        &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'err'</span>, err);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;, </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>在返回结果中加了层判断，压缩后比原来更大，则将原图上传；压缩后比原来小，上传压缩后的。解决压缩后比原图更大的情况。<br><code>this.$api.uploadImage(params)</code> 是调用封装的 api 方法，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上传图片</span></span><br><span class="line">uploadImage(params)&#123;</span><br><span class="line">   <span class="keyword">return</span> axios.post(<span class="string">`<span class="subst">$&#123;base&#125;</span>/api/v1/file`</span>, params, &#123;</span><br><span class="line">     headers: &#123;<span class="string">'content-type'</span>: <span class="string">'multipart/form-data'</span>&#125;</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、使用效果"><a href="#三、使用效果" class="headerlink" title="三、使用效果"></a>三、使用效果</h2><p>先上传一个非常大的，尺寸为 6016 × 4016，16.8M 的大图，看输出日志，压缩后大小仅为 260k 左右。此时判断压缩后比压缩前小，上传压缩图到服务器。</p>
<p><img src="/2020/04/08/2020-04-08/1.jpg" alt></p>
<p>再看个尺寸 300 × 300，12k 的小图，压缩前大小是 11252，压缩后大小是 93656，大了很多。此时判断压缩后比压缩前更大，上传的是原图。</p>
<p><img src="/2020/04/08/2020-04-08/2.jpg" alt></p>
<p>总结：这个工具类对大图的压缩效果很明显，不管多大的图，压缩之后基本不会超过 300k。但对某些小图可能出现压缩完反而更大的情况。在调用的地方加层压缩后和压缩前大小的比较判断，会完美解决这个问题。<br>当然也可以在工具类内部判断，但个人觉得跟业务逻辑相关的代码还是不要放在公用的工具类比较好。</p>
<p><a href="https://juejin.im/post/5e1e8129e51d453cee48cd8b" target="_blank" rel="noopener">原文链接</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yidierh.github.io/2020/04/07/Taro-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yidier">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yidier's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/07/Taro-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/" itemprop="url">Taro 小程序云开发实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-07T22:06:35+08:00">
                2020-04-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">前端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Taro-介绍"><a href="#Taro-介绍" class="headerlink" title="Taro 介绍"></a>Taro 介绍</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><strong>Taro</strong> 是一套遵循 <a href="https://reactjs.org/" target="_blank" rel="noopener">React</a> 语法规范的 <strong>多端开发</strong> 解决方案。</p>
<p>现如今市面上端的形态多种多样，Web、React-Native、微信小程序等各种端大行其道，当业务要求同时在不同的端都要求有所表现的时候，针对不同的端去编写多套代码的成本显然非常高，这时候只编写一套代码就能够适配到多端的能力就显得极为需要。</p>
<p>使用 <strong>Taro</strong>，我们可以只书写一套代码，再通过 <strong>Taro</strong> 的编译工具，将源代码分别编译出可以在不同端（微信/百度/支付宝/字节跳动/QQ/京东小程序、快应用、H5、React-Native 等）运行的代码。</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p><strong>Taro</strong> 遵循 <a href="https://reactjs.org/" target="_blank" rel="noopener">React</a> 语法规范，它采用与 React 一致的组件化思想，组件生命周期与 React 保持一致，同时支持使用 <a href="http://taro-docs.jd.com/taro/docs/jsx.html" target="_blank" rel="noopener">JSX 语法</a>，让代码具有更丰富的表现力，使用 <strong>Taro</strong> 进行开发可以获得和 React 一致的开发体验。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><strong>Taro</strong> 项目基于 node，请确保已具备较新的 node 环境（&gt;=8.0.0），推荐使用 node 版本管理工具 <a href="https://github.com/creationix/nvm" target="_blank" rel="noopener">nvm</a> 来管理 node，这样不仅可以很方便地切换 node 版本，而且全局安装时候也不用加 sudo 了。</p>
<p>首先，你需要使用 npm 或者 yarn 全局安装<code>@tarojs/cli</code>，或者直接使用<a href="https://medium.com/@maybekatz/introducing-npx-an-npm-package-runner-55f7d4bd282b" target="_blank" rel="noopener">npx</a>；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 使用 npm 安装 CLI</span><br><span class="line">$ npm install -g @tarojs&#x2F;cli</span><br><span class="line"># OR 使用 yarn 安装 CLI</span><br><span class="line">$ yarn global add @tarojs&#x2F;cli</span><br><span class="line"># OR 安装了 cnpm，使用 cnpm 安装 CLI</span><br><span class="line">$ cnpm install -g @tarojs&#x2F;cli</span><br></pre></td></tr></table></figure>

<h2 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h2><p>使用命令创建模板项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ taro init myApp</span><br></pre></td></tr></table></figure>

<p>npm 5.2+ 也可在不全局安装的情况下使用 npx 创建模板项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npx @tarojs&#x2F;cli init myApp</span><br></pre></td></tr></table></figure>

<p>选择wxcloud / 小程序云开发模板</p>
<p><img src="/2020/04/07/Taro-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/1.jpg" alt></p>
<p>模板目录结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">├── client                                  小程序端目录</span><br><span class="line">│   ├── config                              配置目录</span><br><span class="line">│   │   ├── dev.js                          开发时配置</span><br><span class="line">│   │   ├── index.js                        默认配置</span><br><span class="line">│   │   └── prod.js                         打包时配置</span><br><span class="line">│   ├── dist                                编译结果目录</span><br><span class="line">│   ├── package.json</span><br><span class="line">│   ├── src                                 源码目录</span><br><span class="line">│   │   ├── app.scss                        项目总通用样式</span><br><span class="line">│   │   ├── app.js                          项目入口文件</span><br><span class="line">│   │   ├── components                      组件文件目录</span><br><span class="line">│   │   │   └── login                       login 组件目录</span><br><span class="line">│   │   │       └── index.weapp.js          login 组件逻辑</span><br><span class="line">│   │   └── pages                           页面文件目录</span><br><span class="line">│   │       └── index                       index 页面目录</span><br><span class="line">│   │           ├── index.scss              index 页面逻辑</span><br><span class="line">│   │           └── index.js                index 页面样式</span><br><span class="line">├── cloud                                   服务端目录</span><br><span class="line">│   └── functions                           云函数目录</span><br><span class="line">│       └── login                           login 云函数</span><br><span class="line">│           ├── index.js                    login 函数逻辑</span><br><span class="line">│           └── package.json</span><br><span class="line">└── project.config.json                     小程序项目配置</span><br></pre></td></tr></table></figure>

<p>使用要点</p>
<ul>
<li><p>开发时，进入 client 目录，在此目录下运行相关编译预览或打包命令</p>
</li>
<li><p>使用微信开发者工具调试项目，请将项目 <strong>整个文件夹</strong> 作为运行目录。 注意： 不是 client 中生成的 dist 文件夹</p>
</li>
</ul>
<h2 id="小程序云函数"><a href="#小程序云函数" class="headerlink" title="小程序云函数"></a>小程序云函数</h2><p>登陆云函数示例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cloud = <span class="built_in">require</span>(<span class="string">'wx-server-sdk'</span>)</span><br><span class="line">cloud.init()</span><br><span class="line">exports.main = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line"> <span class="keyword">const</span> wxContext = cloud.getWXContext()</span><br><span class="line"> <span class="keyword">return</span> &#123;</span><br><span class="line"> openid: wxContext.OPENID,</span><br><span class="line"> appid: wxContext.APPID,</span><br><span class="line"> unionid: wxContext.UNIONID,</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在页面中调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Taro.cloud</span><br><span class="line"> .callFunction(&#123;</span><br><span class="line"> name: <span class="string">"login"</span>,</span><br><span class="line"> data: &#123;&#125;</span><br><span class="line"> &#125;)</span><br><span class="line"> .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">this</span>.setState(&#123;</span><br><span class="line"> context: res.result</span><br><span class="line"> &#125;)</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>

<h2 id="云开发踩坑"><a href="#云开发踩坑" class="headerlink" title="云开发踩坑"></a>云开发踩坑</h2><h4 id="筛选"><a href="#筛选" class="headerlink" title="筛选"></a>筛选</h4><p>小程序云开发数据库的 <a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/database/Collection.html" target="_blank" rel="noopener">Collection</a> 的时间查询和 <a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/database/aggregate/Aggregate.html" target="_blank" rel="noopener">Aggregate</a> 的时间筛选是不一样的。</p>
<p>Collection</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.collection(<span class="string">'record'</span>).where(&#123;</span><br><span class="line">        date: _.and([_.gte(first_day), _.lte(last_day)]),</span><br><span class="line">      &#125;)</span><br><span class="line">      .get()</span><br></pre></td></tr></table></figure>

<p>Aggregate 中筛选日期，需要先使用 <a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/database/command/aggregate/AggregateCommand.dateFromString.html" target="_blank" rel="noopener">dateFromString</a> 转换日期格式，再进行查询</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> queryStart = $.dateFromString(&#123;<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'your start date'</span>).toJSON()</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">let</span> queryEnd = $.dateFromString(&#123;<span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">'your end date'</span>).toJSON()</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line">.aggregate()</span><br><span class="line">            db.collection(<span class="string">'day_record'</span>).addFields(&#123;</span><br><span class="line">                matched: $.and([$.gte([<span class="string">'$date'</span>, queryStart]), $.lte([<span class="string">'$date'</span>, queryEnd])])</span><br><span class="line">            &#125;)</span><br><span class="line">            .match(&#123;</span><br><span class="line">                matched: <span class="literal">true</span>,</span><br><span class="line">                type: type,</span><br><span class="line">                _openid: openid</span><br><span class="line">            &#125;)</span><br><span class="line">            .group(&#123;</span><br><span class="line">                _id: <span class="literal">null</span>,</span><br><span class="line">                total_money: $.sum(<span class="string">'$money'</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">            .end()</span><br></pre></td></tr></table></figure>

<h4 id="定时触发器"><a href="#定时触发器" class="headerlink" title="定时触发器"></a>定时触发器</h4><p>需要在目录添加 <a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html" target="_blank" rel="noopener">config.json</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"triggers"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"timeTrigger"</span>,</span><br><span class="line">      <span class="string">"type"</span>: <span class="string">"timer"</span>,</span><br><span class="line">      <span class="string">"config"</span>: <span class="string">"0 0 9 * * * *"</span> <span class="comment">// 每天早上 9 点触发</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="订阅消息"><a href="#订阅消息" class="headerlink" title="订阅消息"></a>订阅消息</h4><h6 id="步骤一：小程序添加消息模板"><a href="#步骤一：小程序添加消息模板" class="headerlink" title="步骤一：小程序添加消息模板"></a>步骤一：小程序添加消息模板</h6><p>没开通的要先在微信公众平台开通订阅消息功能</p>
<p><img src="/2020/04/07/Taro-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/2.jpg" alt></p>
<p><img src="/2020/04/07/Taro-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/3.jpg" alt></p>
<h6 id="步骤二：获取模板ID"><a href="#步骤二：获取模板ID" class="headerlink" title="步骤二：获取模板ID"></a>步骤二：获取模板ID</h6><p><img src="/2020/04/07/Taro-%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BA%91%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/4.jpg" alt></p>
<h6 id="步骤三：获取下发权限-wx-requestSubscribeMessage"><a href="#步骤三：获取下发权限-wx-requestSubscribeMessage" class="headerlink" title="步骤三：获取下发权限 wx.requestSubscribeMessage"></a>步骤三：获取下发权限 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html" target="_blank" rel="noopener">wx.requestSubscribeMessage</a></h6><h6 id="步骤四：调用接口下发订阅消息-subscribeMessage-send"><a href="#步骤四：调用接口下发订阅消息-subscribeMessage-send" class="headerlink" title="步骤四：调用接口下发订阅消息 subscribeMessage.send"></a>步骤四：调用接口下发订阅消息 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html" target="_blank" rel="noopener">subscribeMessage.send</a></h6><blockquote>
<p>云调用需在  <code>config.json</code>  中配置  <code>subscribeMessage.send</code>  API 的权限，<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/openapi/openapi.html#usage-3" target="_blank" rel="noopener">详情</a></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"permissions"</span>: &#123;</span><br><span class="line">    <span class="string">"openapi"</span>: [</span><br><span class="line">      <span class="string">"subscribeMessage.send"</span>,</span><br><span class="line">      <span class="string">"subscribeMessage.getTemplateList"</span> <span class="comment">// 获取订阅消息模板列表</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发送消息订阅消息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> cloud.openapi.subscribeMessage.send(&#123;</span><br><span class="line">                touser: _openid,</span><br><span class="line">                page: <span class="string">'pages/start/index'</span>,</span><br><span class="line">                data: &#123;</span><br><span class="line">                    amount4: &#123;</span><br><span class="line">                        value: pay + <span class="string">'元'</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    amount5: &#123;</span><br><span class="line">                        value: income + <span class="string">'元'</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    amount10: &#123;</span><br><span class="line">                        value: sum + <span class="string">'元'</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    thing9: &#123;</span><br><span class="line">                        value: <span class="string">'昨日账单'</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    date12: &#123;</span><br><span class="line">                        value: common.dateFormat(<span class="string">"YYYY-mm-dd HH:MM:SS"</span>, date)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                templateId: data[<span class="number">0</span>].priTmplId <span class="comment">// 目前只有一个订阅消息，后期要加这里记得改</span></span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<h2 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a>项目实战</h2><p><a href="https://github.com/yidierh/mini-bookkeeping" target="_blank" rel="noopener">「易丨记账」—— 一款信用卡账单记账小程序</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yidierh.github.io/2020/04/06/%E8%BD%AC%E5%8F%91%E6%88%BF%E4%BA%A7%E6%96%87%E7%AB%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yidier">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yidier's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/06/%E8%BD%AC%E5%8F%91%E6%88%BF%E4%BA%A7%E6%96%87%E7%AB%A0/" itemprop="url">转发房产文章</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-06T20:38:39+08:00">
                2020-04-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/interesting/" itemprop="url" rel="index">
                    <span itemprop="name">interesting</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2020/04/06/%E8%BD%AC%E5%8F%91%E6%88%BF%E4%BA%A7%E6%96%87%E7%AB%A0/IMG_9003.PNG" alt="1"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yidierh.github.io/2020/03/24/Debounce-throttle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yidier">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yidier's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/24/Debounce-throttle/" itemprop="url">Debounce&Throttle</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-24T01:04:01+08:00">
                2020-03-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">前端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>debounce 与 <code>throttle</code> 是开发中常用的高阶函数，作用都是为了防止函数被高频调用，换句话说就是，用来控制某个函数在一定时间内执行多少次。</p>
<p><strong>使用场景</strong>：</p>
<p>比如绑定响应鼠标移动、窗口大小调整、滚屏等事件时，绑定的函数触发的频率会很频繁。若稍处理函数微复杂，需要较多的运算执行时间和资源，往往会出现延迟，甚至导致假死或者卡顿感。为了优化性能，这时就很有必要使用<code>debounce</code>或<code>throttle</code>了。</p>
<p>由于<code>debounce</code>与<code>throttle</code>两个函数的作用相同，且调用方法和参数都相同，这让我们很容易弄混。今天就来谈谈<code>debounce</code>和<code>throttle</code>的用法与差异。</p>
<p>下面先看看<code>lodash</code>中的<code>_.debounce()</code>与<code>_.throttle()</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_.debounce(func, [wait=<span class="number">0</span>], [options=&#123;&#125;]) _.throttle(func, [wait=<span class="number">0</span>], [options=&#123;&#125;])</span><br></pre></td></tr></table></figure>

<p><strong>1. debounce</strong></p>
<p>语法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_.debounce(func, [wait=<span class="number">0</span>], [options=&#123;&#125;])</span><br></pre></td></tr></table></figure>

<p>debounce函数通常称为防抖动函数，该函数会从上一次被调用后，延迟 wait 毫秒后调用 fn 方法</p>
<p><strong>简单实现</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">fn, wait, options</span>) </span>&#123;   </span><br><span class="line"></span><br><span class="line">    wait = wait || <span class="number">0</span>;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> timerId;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">debounced</span>(<span class="params"></span>) </span>&#123;   </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (timerId) &#123;   </span><br><span class="line"></span><br><span class="line">            clearTimeout(timerId);</span><br><span class="line"></span><br><span class="line">            timerId = <span class="literal">null</span>;   </span><br><span class="line"></span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        timerId = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;   </span><br><span class="line"></span><br><span class="line">            fn();     </span><br><span class="line"></span><br><span class="line">      &#125;, wait);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> debounced;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们在<code>debounce</code>函数中定义了一个<code>debounced()</code>函数，内部定义了一个定时器，每当触发事件时，都会重置定时器，也就是说，当事件被执行时，并不会立刻执行fn，而是等待一定时间(wait)后才会执行。如果wait过后，函数没有再次被执行，就会处理最后一个fn。</p>
<p>注意：即使还有0.01秒就到指定时间，如果这时又执行了一次函数，那么之前的定时器就会被取消，需要重新等待到达指定时间。</p>
<p><strong>2. Throttle</strong></p>
<p>语法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_.throttle(func, [wait=<span class="number">0</span>], [options=&#123;&#125;])</span><br></pre></td></tr></table></figure>

<p>节流函数，在 wait 秒内最多执行 fn 一次的函数。</p>
<p>与<code>deboucne</code>不同的是，<code>throttle</code>会有一个阀值，当到达阀值时，fn一定会执行。</p>
<p><strong>简单实现</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throttle</span>(<span class="params">fn, wait, options</span>) </span>&#123;   </span><br><span class="line"></span><br><span class="line">    wait = wait || <span class="number">0</span>;   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> timerId, lastTime = <span class="number">0</span>;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">throttled</span>(<span class="params"></span>) </span>&#123;   </span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> currentTime = <span class="keyword">new</span> <span class="built_in">Date</span>();   </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentTime &gt;= lastTime + wait) &#123;   </span><br><span class="line"></span><br><span class="line">            fn();   </span><br><span class="line"></span><br><span class="line">            lastTime = currentTime;   </span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;   </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (timerId) &#123;   </span><br><span class="line"></span><br><span class="line">                clearTimeout(timerId);   </span><br><span class="line"></span><br><span class="line">                timerId = <span class="literal">null</span>;   </span><br><span class="line"></span><br><span class="line">            &#125;   </span><br><span class="line"></span><br><span class="line">            timerId = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;   </span><br><span class="line"></span><br><span class="line">                fn()   </span><br><span class="line"></span><br><span class="line">            &#125;, wait);   </span><br><span class="line"></span><br><span class="line">       &#125;   </span><br><span class="line"></span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> throttled;  </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码中，我们会记录每次函数被实际调用的时间，如果下次调用时，还没到达阀值，就会继续等待，直到到达阀值，就会调用最后一次函数。</p>
<p><strong>完整实例</strong></p>
<p><a href="https://codepen.io/TGCode/pen/jZodyM" target="_blank" rel="noopener">https://codepen.io/TGCode/pen/jZodyM</a></p>
<p><strong>总结</strong></p>
<ul>
<li><code>debounce</code>：将触发频繁的事件合并成一次执行。<code>debounce</code>适用于诸如input事件，当用户输入时需要响应ajax请求，多次input只响应一次回调方法</li>
<li><code>throttle</code>： 设置一个阀值，在阀值内，将触发的事件合并成一次执行；且当到达阀值，必定执行一次事件。<code>throttle</code>适用于resize或者鼠标移动事件，防止浏览器频繁响应事件，严重拉低性能</li>
</ul>
<p>参考文章</p>
<ul>
<li><p><a href="http://benalman.com/projects/jquery-throttle-debounce-plugin/" target="_blank" rel="noopener">Ben Alman &raquo; jQuery throttle / debounce: Sometimes, less is more!</a></p>
</li>
<li><p><a href="https://css-tricks.com/the-difference-between-throttling-and-debouncing/" target="_blank" rel="noopener">Flywheel logo</a></p>
</li>
</ul>
<p><a href="https://laixiazheteng.com/article/page/id/4qrB9JeihTKD" target="_blank" rel="noopener">原文链接</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yidierh.github.io/2020/03/22/%E5%89%8D%E7%AB%AF%E7%BA%BF%E7%A8%8B%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yidier">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yidier's blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/22/%E5%89%8D%E7%AB%AF%E7%BA%BF%E7%A8%8B%E7%90%86%E8%A7%A3/" itemprop="url">前端线程理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-22T00:59:49+08:00">
                2020-03-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">前端开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>很多文章在介绍线程以及线程之间的关系，都存在着脱节的现象。还有的文章过于广大，涉及到了内核，本文希望以通俗易懂的话去描述晦涩的词语，可能会和实际有一丢丢的出入，但是更易理解。</p>
<p>我们都知道JS是单线程的，即js的代码只能在一个线程上运行，也就说，js同时只能执行一个js任务，但是为什么要这样呢？这与浏览器的用途有关，JS的主要用途是与用户互动和操作DOM。设想一段JS代码，分发到两个并行互不相关的线程上运行，一个线程在DOM上添加内容，另一个线程在删除DOM，那么会发生什么？以哪个为准？所以为了避免复杂性，JS从一开始就是单线程的，以后也不会变。</p>
<p>这里我们已经知道了，一段JS代码只能在一个线程从上到下的执行，但是我们遇到setTimeout或者ajax异步时，也没有等待啊，往下看。</p>
<h2 id="2-浏览器"><a href="#2-浏览器" class="headerlink" title="2. 浏览器"></a>2. 浏览器</h2><p>既然JS是单线程的，那么诸如onclick回调，setTimeout，Ajax这些都是怎么实现的呢？是因为浏览器或node（宿主环境）是多线程的，即浏览器搞了几个其他线程去辅助JS线程的运行。</p>
<p>浏览器有很多线程，例如：</p>
<ol>
<li><p>GUI 渲染线程</p>
</li>
<li><p>JS 引擎线程</p>
</li>
<li><p>定时器触发线程 (setTimeout)</p>
</li>
<li><p>浏览器事件线程 (onclick)</p>
</li>
<li><p>http 异步线程</p>
</li>
<li><p>EventLoop轮询处理线程</p>
<p>…</p>
</li>
</ol>
<p>其中，1、2、4为常驻线程</p>
<p>接下来，我们对这些线程进行分类。</p>
<h2 id="3-线程与进程"><a href="#3-线程与进程" class="headerlink" title="3. 线程与进程"></a>3. 线程与进程</h2><p>什么是进程？</p>
<p>我们可以在电脑的任务管理器中查看到正在运行的进程，可以认为一个进程就是在运行一个程序，比如用浏览器打开一个网页，这就是开启了一个进程。但是比如打开3个网页，那么就开启了3个进程，我们这里只研究打开一个网页即一个进程。</p>
<p>一个<strong>进程</strong>的运行，当然需要很多个<strong>线程</strong>互相配合，比如打开QQ的这个进程，可能同时有接收消息线程、传输文件线程、检测安全线程……所以一个网页能够正常的运行并和用户交互，也需要很多个进程之间相互配合，而其主要的一些线程，刚才在上面已经列出来了，分类：</p>
<p>类别A：GUI 渲染线程</p>
<p>类别B：JS 引擎线程</p>
<p>类别C：EventLoop轮询处理线程</p>
<p>类别D：其他线程，有 定时器触发线程 (setTimeout)、http 异步线程、浏览器事件线程 (onclick)等等。</p>
<p><strong>注意：</strong> 类别A和类别B是互斥的，原因不用说了，不知道的看我上一篇文章。所以我们下面的讨论，就不涉及类别A了，只讨论类别B、C、D之间的关系。</p>
<h4 id="类别B："><a href="#类别B：" class="headerlink" title="类别B："></a>类别B：</h4><p>JS 引擎线程，我们把它称为<strong>主线程</strong>，它是干嘛的？即运行JS代码的那个线程（不包括异步的那些代码），比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 var a &#x3D; 2;</span><br><span class="line">2 setTimeout()</span><br><span class="line">3 ajax()</span><br><span class="line">4 console.log()</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>第1、4行代码是同步代码，直接在主线程中运行；第2、3行代码交给其他线程运行。</p>
<p>主线程运行JS代码时，会生成个<strong>执行栈</strong>，可以处理函数的嵌套，通过出栈进栈这样，这里不做过多介绍，很多文章。</p>
<h4 id="消息队列（任务队列）"><a href="#消息队列（任务队列）" class="headerlink" title="消息队列（任务队列）"></a>消息队列（任务队列）</h4><p>可以理解为一个静态的队列存储结构，非线程，只做存储，里面存的是一堆异步成功后的回调函数<strong>字符串</strong>，肯定是先成功的异步的回调函数在队列的前面，后成功的在后面。</p>
<p>注意：是异步成功后，才把其回调函数扔进队列中，而不是一开始就把所有异步的回调函数扔进队列。比如setTimeout 3秒后执行一个函数，那么这个函数是在3秒后才进队列的。</p>
<h4 id="类别D："><a href="#类别D：" class="headerlink" title="类别D："></a>类别D：</h4><p>定时器触发线程 (setTimeout)、http 异步线程、浏览器事件线程 (onclick)</p>
<p>主线程执行JS代码时，碰到异步代码，就把它丢给各自相对应的线程去执行，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 var a &#x3D; 2;</span><br><span class="line">2 setTimeout(fun A)</span><br><span class="line">3 ajax(fun B)</span><br><span class="line">4 console.log()</span><br><span class="line">5 dom.onclick(func C)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>主线程在运行这段代码时，碰到2 setTimeout(fun A)，把这行代码交给<strong>定时器触发线程</strong>去执行</p>
<p>碰到3 ajax(fun B)，把这行代码交给<strong>http 异步线程</strong>去执行</p>
<p>碰到5 dom.onclick(func C) ，把这行代码交给<strong>浏览器事件线程</strong>去执行</p>
<p><strong>注意：</strong> 这几个异步代码的回调函数fun A，fun B，fun C，各自的线程都会保存着的，因为需要在未来的某个时候，将回调函数交给主线程去执行啊。。。</p>
<p>所以，这几个线程主要干两件事：</p>
<ol>
<li>执行主线程扔过来的异步代码，并执行代码</li>
<li>保存回调函数，在未来的某个时刻，通知<strong>EventLoop轮询处理线程</strong>过来取相应的回调函数然后执行（下面会讲）</li>
</ol>
<h4 id="类别C："><a href="#类别C：" class="headerlink" title="类别C："></a>类别C：</h4><p>EventLoop轮询处理线程</p>
<p>上面我们已经知道了，有3个东西</p>
<ol>
<li>主线程，处理同步代码</li>
<li>类别D的几个异步线程，处理异步代码</li>
<li>消息队列，存储着异步成功后的回调函数，一个静态存储结构</li>
</ol>
<p>这里再对消息队列说一下，其作用就是存放着未来要执行的回调函数，比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(() &#x3D;&gt; &#123;</span><br><span class="line">    console.log(1)</span><br><span class="line">&#125;, 2000)</span><br><span class="line">setTimeout(() &#x3D;&gt; &#123;</span><br><span class="line">    console.log(2)</span><br><span class="line">&#125;, 3000)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>在一开始，消息队列是空的，在2秒后，一个 () =&gt; { console.log(1) } 的函数进入队列，在3秒后，一个 () =&gt; { console.log(2) }的函数进入队列，此时队列里有两个元素，主线程从队列头中挨个取出并执行。</p>
<p>到这里我们就知道了，这3个东西大概的作用、关系和流程，但是，它们3个互相怎么交流的？这需要一个中介去专门去沟通它们3个，而这个中介，就是<strong>EventLoop轮询处理线程</strong></p>
<p>既然叫轮询了，那么肯定是不断的循环的去交流和沟通</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/4/16818b1c01ca7df3?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt></p>
<p>图画的有点丑，但是大概是这个意思，从主线程那里顺时针的看。</p>
<p>注意整个的流程是循环往复的。</p>
<p>注意只有主线程的同步代码都执行完了，才会去队列里看看还有啥要执行的没</p>
<h4 id="小区别"><a href="#小区别" class="headerlink" title="小区别"></a>小区别</h4><p>在异步线程类别D那里，还有一些小区别：</p>
<p>主线程把setTimeout、ajax、dom.onclick分别给三个线程，他们之间有些不同</p>
<ul>
<li><p>对于setTimeout代码，定时器触发线程在接收到代码时就开始计时，<strong>时间到了将回调函数扔进队列</strong>。</p>
</li>
<li><p>对于ajax代码，http 异步线程立即发起http请求，<strong>请求成功后将回调函数扔进队列</strong>。</p>
</li>
<li><p>对于dom.onclick，浏览器事件线程会先监听dom，直到<strong>dom被点击了，才将回调函数扔进队列</strong>。</p>
</li>
</ul>
<h2 id="4-总体实例"><a href="#4-总体实例" class="headerlink" title="4. 总体实例"></a>4. 总体实例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">var a &#x3D; 111;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setTimeout(function() &#123;</span><br><span class="line">    console.log(222)</span><br><span class="line">&#125;, 2000)</span><br><span class="line"></span><br><span class="line">fetch(url)  &#x2F;&#x2F; 假设该http请求花了3秒钟</span><br><span class="line">.then(function() &#123;</span><br><span class="line">    console.log(333)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">dom.onclick &#x3D; function() &#123;  &#x2F;&#x2F; 假设用户在4秒钟时点击了dom</span><br><span class="line">    console.log(444)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">console.log(555)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 结果</span><br><span class="line">555</span><br><span class="line">222</span><br><span class="line">333</span><br><span class="line">444</span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h4 id="步骤1："><a href="#步骤1：" class="headerlink" title="步骤1："></a>步骤1：</h4><p><img src="https://user-gold-cdn.xitu.io/2019/1/8/1682b7332de955ca?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt></p>
<p>主线程只执行了var a = 111;和console.log(555)两行代码，其他的代码分别交给了其他三个线程，因为其他线程需要2、3、4秒钟才成功并回调，所以在2秒之前，主线程一直在空闲，不断的探查队列是否不为空。</p>
<p>此时主线程里其实已经是空的了（因为执行完那两行代码了）</p>
<h4 id="步骤2："><a href="#步骤2：" class="headerlink" title="步骤2："></a>步骤2：</h4><p>2秒钟之后，setTimeout成功了</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/8/1682b7034ad6ad14?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt></p>
<h4 id="步骤3："><a href="#步骤3：" class="headerlink" title="步骤3："></a>步骤3：</h4><p><img src="https://user-gold-cdn.xitu.io/2019/1/8/1682b77b0839fc10?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt></p>
<h4 id="步骤4："><a href="#步骤4：" class="headerlink" title="步骤4："></a>步骤4：</h4><p><img src="https://user-gold-cdn.xitu.io/2019/1/8/1682b7a5e48665e4?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt></p>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>图里的队列里都只有一个回调函数，实际上有很多个回调函数，如果主线程里执行的代码复杂需要很长时间，这时队列里的函数们就排着，等着主线程啥时执行完，再来队列里取</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/8/1682b7da0f89d552?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt></p>
<p>所以从这里能看出来，对于setTimeout，setInterval的定时，不一定完全按照设想的时间的，因为主线程里的代码可能复杂到执行很久，所以会发生你定时3秒后执行，实际上是3.5秒后执行（主线程花费了0.5秒）</p>
<p>之后我会再写如何解决定时误差的内容。。。</p>
<h3 id="借两个经典的图"><a href="#借两个经典的图" class="headerlink" title="借两个经典的图"></a>借两个经典的图</h3><p><img src="https://user-gold-cdn.xitu.io/2019/1/4/16818e049fd1a479?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt></p>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/4/16818e06c0ce968a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt></p>
<p><a href="https://juejin.im/post/5c2ec3b66fb9a049eb3c1012" target="_blank" rel="noopener">原文地址</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">yidier</p>
              <p class="site-description motion-element" itemprop="description">a web developer</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
                <a href="/archives">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/eddieyd" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yidierh@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yidier - web developers</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
